name: Verify
on:
  push:
    branches: [main]
    paths:
      - .github/actions/**
      - .github/workflows/verify.yml
      - api/**
      - deploy/**
      - portal/**
      - go.*
      - skaffold.yaml
  workflow_dispatch:
defaults:
  run:
    shell: bash -eu {0}
jobs:
  verify:
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Runner
        uses: ./.github/actions/setup-runner
        with:
          gcp-project-id: ${{ secrets.GCP_PROJECT_ID }}
          gcp-service-account-key: ${{ secrets.GCP_SA_KEY }}
      - name: Build
        run: skaffold build --file-output=skaffold-tags.json --profile=ci
      - name: Deploy to local cluster
        run: skaffold deploy --build-artifacts=skaffold-tags.json --profile=ci
      - run: |-
          kubectl port-forward service/api 8081:80 &
          kubectl port-forward service/portal 8080:80 &
          sleep 3
          curl -isSL http://localhost:8080
          curl -isSL http://localhost:8081
      - name: Render Kubernetes manifests
        run: skaffold render --build-artifacts=build.json --profile=ci --output=devbot.yaml
      # TODO: clone infrastructure repo, commit devbot.yaml for FluxCD to apply to cluster
